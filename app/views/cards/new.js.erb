var handler = StripeCheckout.configure({
    key: '<%= Rails.application.credentials[Rails.env.to_sym][:stripe_public] %>',
    //get a publishable key that we put in editor depending on environment: production or development
    locale: 'auto',
    //handle translation
    name: "TheDiasporaProject",
    description: "Add your credit card information",
    email: "<%= @user.email %>",
    panelLabel: "Add payment method",
    allowRememberMe: false,
    token: function (token) {
        console.log("Token: ", token)
        var form = document.getElementById("plan-<%= @plan.id %>");
        //we will create element with this id in the next step
        var hiddenInput = document.createElement('input');
        hiddenInput.setAttribute('type', 'hidden');
        hiddenInput.setAttribute('name', 'stripeToken');
        hiddenInput.setAttribute('value', token.id);

        // card details
        $("#card_last4_<%= @plan.id %>").val(token.card.last4);
        $("#card_exp_month_<%= @plan.id %>").val(token.card.exp_month);
        $("#card_exp_year_<%= @plan.id %>").val(token.card.exp_year);
        $("#card_brand_<%= @plan.id %>").val(token.card.brand);

        //creating an <input type="hidden" name="stripeToken" value="<id>"/>. We will need this information in the next steps to link a user to his card
        form.appendChild(hiddenInput);
        //adding this input when we use a form.
        form.submit();
    }
});

handler.open();

window.addEventListener('popstate', function() {
    handler.close();
});